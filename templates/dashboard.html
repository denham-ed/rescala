{% extends "base.html" %}

{% block title%}
Rescala | Dasboard
{% endblock%}

{% load crispy_forms_tags%}
{% crispy form form.helper %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col">
      <h1>Dashboard</h1>
      <hr />
    </div>
  </div>
  <div class="row">
    <div class="col-md-8 offset-md-2">
      {% for message in messages %}
      <div class="alert {{ message.tags}} alert-dismissible fade show" id="msg" role="alert">
        {{ message | safe }}
        <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="row" data-masonry='{"percentPosition": true }'>
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card dashboard-card">
        <div class="card-body">
          <div class="dashboard-title">
            <h3>Recent Practice</h3>
          </div>
          {% if sessions %}
          <div class="dashboard-content">
            <table>
              <tbody>
                {% for session in recent_sessions %}
                <tr class="practice-row">
                  <td class="date-cell">
                    <a href="{% url 'session_details' session.id %}">
                      {{session.date | date:'D d M y'}}
                    </a>
                  </td>
                  <td>
                    <a href="{% url 'session_details' session.id %}">
                      <span class="fw-bold">
                        {{session.headline}}
                      </span>

                    </a>
                  </td>
                </tr>
                {% empty %}
                <p>This is where your logged practices will appear!</p>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card dashboard-card">
        <div class="card-body">
          <div class="dashboard-title">
            <h3>My Goals </h3>
          </div>
          <div class="dashboard-content">
            {%for goal in goals%}
            <div>
              {{goal.goal}}
              <form method="POST" action="{% url 'update_goal' forloop.counter0 %}">
                {% csrf_token %}
                <div class="row">
                  <div class="col-md-8">
                    <div class="progress goal-progress" data-goal-id="{{forloop.counter}}">
                      <div class="progress-bar" role="progressbar" style="width: {{goal.complete}}%" aria-valuenow="25"
                        aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-center">
                      <div class="spinner-border" role="status" data-goal-id="{{forloop.counter}}">
                        <span class="sr-only">Loading...</span>
                      </div>
                    </div>
                    <input type="range" data-goal-id="{{forloop.counter}}" class="w-100 edit-goal-range"
                      value="{{goal.complete}}" name="goal-complete">
                  </div>
                  <div class="col-md-4 d-flex">
                    <button type='button' data-goal-id="{{forloop.counter}}"
                      class=" edit-goal-button btn btn-sm btn-dark"><i class="fa-solid fa-pen"></i></button>
                    <button type='submit' data-goal-id="{{forloop.counter}}" class="save-goal-button btn btn-sm btn-dark"><i
                        class="fa-regular fa-circle-check"></i></button>
              </form>
              <form method="POST" action="{% url 'delete_goal' forloop.counter0 %}" class="d-flex ">
                {% csrf_token %}
                <button  type='button' data-goal-id="{{forloop.counter}}"
                class="delete-goal-button btn btn-sm btn-very-dark ms-2"><i class="fa-solid fa-xmark"></i></button>
                <button  type='button' data-goal-id="{{forloop.counter}}"
                class="revert-goal-button btn btn-sm btn-dark"><i
                class="fa-regular fa-circle-check"></i></button>
                <button type='submit' data-goal-id="{{forloop.counter}}" class="confirm-delete-button btn btn-sm btn-red ms-2">
                  <i class="fa-solid fa-trash"></i>
                </button>
                </form>
            </div>
          </div>

        </div>
        {% endfor %}
        <button type="button" class="btn btn-sm btn-very-dark" data-toggle="modal" data-target="#goalModal"> Add
          Goal
        </button>
      </div>
    </div>
  </div>
</div>
<div class="col-md-6 col-lg-4 mb-4">
  <div class="card dashboard-card">
    <div class="card-body">
      <div class="dashboard-title">
        <h3>Moods</h3>
      </div>
      <div class="dashboard-content">
        {% for word in wordcloud %}
        {% if word.count > 10 %}
        <span class="wordcloud-lg">{{word.mood}} </span>
        {% elif word.count > 5%}
        <span class="wordcloud-md">{{word.mood}} </span>
        {% elif word.count > 2%}
        <span class="wordcloud-sm">{{word.mood}} </span>
        {% else %}
        <span class="wordcloud-xs">{{word.mood}} </span>
        {% endif %}
        {% empty %}
        <p>Log a session to start learning more about how you feel about your practice sessions.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<div class="col-md-6 col-lg-4 mb-4">
  <div class="card dashboard-card">
    <div class="card-body">
      <div class="dashboard-title">
        <h3>Last 30 Days</h3>
      </div>
      <div class="dashboard-content">
        <div class="calendar-container d-flex flex-wrap">
          {% for day in dates %}
          {% if day.practice%}
          <div class="calendar-day practiced" data-toggle="tooltip" data-placement="top"
            title="{{ day.date | date:'D d M y' }}"></div>
          {% else %}
          <div class="calendar-day" data-toggle="tooltip" data-placement="top" data-html="true"
            title="{{ day.date | date:'D d M y' }}"></div>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
<div class="col-md-6 col-lg-4 mb-4">
  <div class="card dashboard-card">
    <div class="card-body">
      <div class="dashboard-title">
        <h3>Focus</h3>
      </div>
      <div class="dashboard-content">
        <canvas id="focus-chart"></canvas>
      </div>
    </div>
  </div>
</div>
<div class="col-md-6 col-lg-4 mb-4">
  <div class="card dashboard-card">
    <div class="card-body">
      <div class="dashboard-title">
        <h3>Total Practice</h3>
      </div>
      <div class="dashboard-content">
        <div class="row">
          <div class="col-md-6">
            <div class="tally-container">
              <div class="accent-header">7 Days</div>
              {{practice_totals.weekly}} mins
            </div>
          </div>
          <div class="col-md-6 mt-2 mt-md-0">
            <div class="tally-container">
              <div class="accent-header">30 Days</div>
              {{practice_totals.monthly}} mins
            </div>
          </div>
          <div class="col-md-6 mt-2">
            <div class="tally-container">
              <div class="accent-header">Total</div>
              {{practice_totals.total}} mins
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
<div class="col-md-6 col-lg-4 mb-4">
  <div class="card dashboard-card">
    <div class="card-body">
      <div class="dashboard-title">
        <h3>My Resources</h3>
      </div>
      <div class="dashboard-content">
        <ul>
          {% for resource in resources%}
          <li class="resource-list-item">
            <a href="{% url 'resource_details' resource.id %}">
              <span class="fw-bold">{{resource.title}}</span>
            </a>
          </li>
          {% empty %}
          <div>Here you can see all your favourite articles, tips and interviews. Head over to Resources to get
            started.
          </div>
          {%endfor%}
        </ul>
      </div>
    </div>
  </div>
</div>
</div>
{% else %}
<!-- CHECK STYLING?? -->
<div class="row">
  <div class="col-md-12">
    <div class="dashboard-item">
      <h3>Welcome to Rescala, {{user.first_name}}</h3>
      <div>This is your Dashboard; from here you will be able to track your practices, learn more about how you are
        feeling and start to move towards your musical goals.</div>
      <div>You've done the hard work! Just log your first practice to get started.</div>
    </div>
  </div>
</div>
{% endif %}
</div>
<!-- Add Goal Modal -->
<div class="modal fade" id="goalModal" tabindex="-1" role="dialog" aria-labelledby="goalModal" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="add-goal-modal-label">Add Goal</h5>
      </div>
      <div class="modal-body">
        {% crispy goalform %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{%block scripts%}
<script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"
  integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // jquery function
  // https://www.section.io/engineering-education/integrating-chart-js-in-django/
  $(document).ready(function () {
    try {
      var ctx = document.getElementById('focus-chart').getContext('2d');
      var myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: [{%for focus in focus_list %}'{{focus.focus | capfirst }}',{% endfor %}],
    datasets: [{
      label: '# of practice sessions',
      data: [{%for focus in focus_list %}{{ focus.count }}, {% endfor %}],
    backgroundColor: [
    'rgba(53, 88, 52, 0.2)',
    'rgba(184, 12, 9, 0.2)',
    'rgba(255, 255, 255, 1)',
    'rgba(20, 40, 29, 0.2)',
    'rgba(119, 119, 119, 0.2)',
    'rgba(232, 241, 242, 0.2)'
  ],
    borderColor: [
    'rgba(53, 88, 52, 1)',
    'rgba(184, 12, 9, 1)',
    'rgba(0,0,0,1)',
    'rgba(20, 40, 29, 1)',
    'rgba(119, 119, 119, 1)',
    'rgba(0,0,0,1)'
  ],
    borderWidth: 1
                    }]
                },
    options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
      },
    }
  },
    });
      } catch (e) {

  }

        });
</script>
{%endblock scripts%}